<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Agent Chat</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="static/css/style.css">
</head>

<body>
    <h1>Chat with Agents</h1>
    <section class="page-content">
        <div class="contacts">

            <button class="pointer" onclick="setChat('Tea from Olympus')">
                <div class="contact">
                    <img src="static/contacts/Tea from Olympus.jpeg" height="50" width="50" alt="">
                    <p>Tea from Olympus</p>
                </div>
            </button>

            <button class="pointer" onclick="setChat('Aphrodite')">
                <div class="contact">
                    <img src="static/contacts/aphrodite.jpeg" height="50" width="50" alt="">
                    <p>Aphrodite</p>
                </div>
            </button>

            <button class="pointer" onclick="setChat('Apollo')">
                <div class="contact">
                    <img src="static/contacts/apollo.jpeg" height="50" width="50" alt="">
                    <p>Apollo</p>
                </div>
            </button>

            <button class="pointer" onclick="setChat('Ares')">
                <div class="contact">
                    <img src="static/contacts/ares.jpeg" height="50" width="50" alt="">
                    <p>Ares</p>
                </div>
            </button>

            <button class="pointer" onclick="setChat('Athena')">
                <div class="contact">
                    <img src="static/contacts/athena.jpeg" height="50" width="50" alt="">
                    <p>Athena</p>
                </div>
            </button>

            <button class="pointer" onclick="setChat('Hades')">
                <div class="contact">
                    <img src="static/contacts/hades.jpeg" height="50" width="50" alt="">
                    <p>Hades</p>
                </div>
            </button>

            <button class="pointer" onclick="setChat('Poseidon')">
                <div class="contact">
                    <img src="static/contacts/poseidon.jpeg" height="50" width="50" alt="">
                    <p>Poseidon</p>
                </div>
            </button>

            <button class="pointer" onclick="setChat('Zeus')">
                <div class="contact">
                    <img src="static/contacts/zeus.jpeg" height="50" width="50" alt="">
                    <p>Zeus</p>
                </div>
            </button>

        </div>
        <div class="chat-container">
            <section id="chat-header">
                <img id="profile-picture" src="/static/contacts/zeus.jpeg" width="60" height="60" alt="">
                <p id="contact-name">Zeus</p>
             </section>
            <div id="chat"></div>
            <input type="text" id="topic_input" placeholder="Message...." autocomplete="off" />
            <button onclick="startConversation()">Send</button>
        </div>
    </section>
    <script>
        let socket = io.connect('http://127.0.0.1:5000');
        let currentMessageContainer = null;
        let currentRole = null;
        let currentContact = ""

        document.getElementById("topic_input").addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                startConversation();
            }
        });

        socket.on('new_message', function (msg) {
            let chat = document.getElementById('chat');

            // Check if the role has changed or if there is no current message container
            if (currentRole !== msg.role || !currentMessageContainer) {
                // Create a new message container for each new message
                currentMessageContainer = document.createElement('div');
                currentMessageContainer.className = 'message';
                chat.appendChild(currentMessageContainer);
                currentRole = msg.role;
            }

            // Update the current message container with the new content
            currentMessageContainer.innerHTML = `<b>${msg.role}</b>: ${msg.content}`;
            chat.scrollTop = chat.scrollHeight;  // Scroll to the bottom
        });

        function startConversation() {
            let input = document.getElementById('topic_input');
            let topic = input.value;
            // adding the recipient and the starting message to the emitted message
            socket.emit('start_conversation', { topic: topic, contact: currentContact});
            input.value = '';
        }

        function setChat(contact){
            console.log("Starting chat with " + contact)
            currentContact = contact
            socket.emit("set_chat", { contact: contact })
            //TODO: reset the chatcontent
            document.getElementById("chat").innerHTML = ""
            document.getElementById("contact-name").innerHTML = contact
            document.getElementById("profile-picture").src = `/static/contacts/${contact.toLowerCase()}.jpeg`
            
        }
    </script>
</body>

</html>